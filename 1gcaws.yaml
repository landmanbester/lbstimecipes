_include:
  - kubeconfig.yaml
  - (cultcargo)quartical.yml
  - (cultcargo)pfb-imaging.yml

opts:  # This section is largely just to ensure that all these fields exist.
  backend:
    select: kube
    kube:
      job_pod:
        memory:
          limit: 0
        cpu:
          request:
            0
      dask_cluster:
        num_workers: 1
        worker_pod:
          memory:
            limit: 0
          cpu:
            request:
              0

1gc:
  name: CROSSCAL
  info: Demo crosscal on AWS

  assign:
    ms1: s3://ratt-public-data/ESO137/ms1_target.zarr
    ms2: s3://ratt-public-data/ESO137/ms2_target.zarr
    gain1: s3://ratt-public-data/ESO137/ms1_gains.qc/GKB-net
    gain2: s3://ratt-public-data/ESO137/ms2_gains.qc/GKB-net

  assign_based_on:
    band:
      FULL:
        frange: 882541016:1626316406.25
      HI:
        frange: 1295000000:1503000000
      LO:
        frange: 980000000:1080000000

  inputs:
    band:
      default: FULL
      info: FULL, HI or LO part of the band.
    basedir:
      default: 's3://rarg-test-binface/ESO137'
    log-directory:
      default: 'output/logs'
      aliases: ['*.log-directory']
    data-column:
      default: DATA
    sigma-column:
      default: SIGMA_SPECTRUM
      info: Original std of noise used to construct weights
    model-column:
      dtype: str
      default: MODEL_DATA
    nband:
      default: 14
      aliases: ['*.nband']
      info: Number of imaging bands
    scheduler:
      dtype: str
      default: distributed
      aliases: ['*.scheduler']
      info: Dask scheduler to use
    nthreads:
      dtype: int
      default: 64
    nworkers:
      dtype: int
      default: 32

  steps:
    init:
      cab: pfb.imit
      assign:
        config.opts.backend.kube.dask_cluster.num_workers: =recipe.nworkers
      info: 'Initialise imaging data products'
      backend:
        kube:
          job_pod:  # This is where the main application runs.
            type: thin
          dask_cluster:  # Set up the dask cluster.
            enable: true
            name: pfb-test-cluster
            memory_limit: 0
            threads_per_worker: 1
            worker_pod:
              type: thin
          always_pull_images: true

      params:
        ms: [=recipe.ms1, =recipe.ms2]
        output-filename: '{recipe.basedir}/stage1_{recipe.band}'
        data-column: =recipe.data-column
        sigma-column: =recipe.sigma-column
        gain-table: [=recipe.gain1, =recipe.gain2]
        integrations-per-image: 150
        channels-per-image: 256
        nthreads-dask: 1
        nvthreads: 1
        nworkers: =recipe.nworkers
        scheduler: distributed
        chan-average: 4
        freq-range: =recipe.frange
        overwrite: true

    deconv:
      cab: pfb.spotless
      params:
        output-filename: '{recipe.basedir}/stage1_{recipe.band}'
        fits-cubes: true
        niter: 50
        bases: 'self,db1'
        nlevels: 3
        l1reweight-from: 6
        pd-tol: 3e-4
        pd-maxit: 500
        pd-verbose: 2
        pd-report-freq: 50
        tol: 1e-3
        rmsfactor: 1.25
        nthreads-dask: 1
        nvthreads: 5
        nworkers: 14
        scheduler: distributed
        field-of-view: 2.25
        super-resolution-factor: 2.0
        robustness: -1.5
        mf-weighting: false
        l2-reweight-dof: 2.5

# command:
# pfb init --ms s3://ratt-public-data/ESO137/ms2_target.zarr -o s3://rarg-test-binface/pfb-test/test --nthreads-dask 15 --nvthreads 1 --scheduler distributed --integrations-per-image 150 --channels-per-image 64 --nworkers 2 --overwrite --data-column DATA --sigma-column SIGMA_SPECTRUM
# gain table not currently accessible
# --gain-table s3://ratt-public-data/ESO137/ms2_gains.qc --gain-term GK-net
