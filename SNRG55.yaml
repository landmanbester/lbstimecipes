_include:
  - (pfb)stimela_cabs.yml

opts:
  log:
    dir: logs
    nest: 2

init:
  name: spotless
  info: Initialise Stokes data products for a single dataset

  inputs:
    ms:
      dtype: List[str]
      required: true
    basedir:
      dtype: str
      required: true
    nthreads_dask:
      dtype: int
      default: 4
    nvthreads:
      dtype: int
      default: 2
    data_column:
      default: DATA
      dtype: str
    weight_column:  # not used by default
      dtype: str
    flag_column:
      default: FLAG
      dtype: str

  steps:
    init_obs:
      cab: pfb_init
      info:
        Initialise imaging data products
      params:
        ms: =recipe.ms
        output_filename: '{recipe.basedir}/data'
        log_directory: '{recipe.basedir}/logs'
        data_column: =recipe.data_column
        flag_column: =recipe.flag_column
        nthreads_dask: =recipe.nthreads_dask
        nvthreads: =recipe.nvthreads


init_loop:
  info: init loop over datasets

  assign:
    obs: F000

  for_loop:
    var: obs
    over: [F000, F001, F005, F01]
    # scatter: 4  # to do it in parallel

  # observation specific settings in subsections
  assign_based_on:
    obs:
      F000:
        ms: [msdir/SNR_G55_10s.calib.ms]
      F001:
        ms: [msdir/SNR_G55_10s.calib.unflagged_0.001.ms]
      F005:
        ms: [msdir/SNR_G55_10s.calib.unflagged_0.005.ms]
      F01:
        ms: [msdir/SNR_G55_10s.calib.unflagged_0.01.ms]

  inputs:
    nthreads_dask:
      dtype: int
      default: 4
    nvthreads:
      dtype: int
      default: 2
    data_column:
      default: DATA
      dtype: str
    weight_column:
      default: UNSET  # not used by default
      dtype: str
    flag_column:
      default: FLAG
      dtype: str

  steps:
    make_xds:
      recipe: init
      params:
        ms: =recipe.ms
        basedir: 'output/{recipe.obs}'
        nthreads_dask: =recipe.nthreads_dask
        nvthreads: =recipe.nvthreads
        data_column: =recipe.data_column
        weight_column: =recipe.weight_column
        flag_column: =recipe.flag_column


em_spotless:
  info: Loop over em_steps

  for_loop:
    var: iter
    over: iters

  inputs:
    basedir:
      required: true
    obs:
      choices: ['F000', 'F001', 'F005', 'F01']
      required: true
    iters:
      dtype: List[int]
      default: [0,1,2,3,4,5,6,7]
      info:
        List enumerating number of EM steps to perform
    data_column:
      default: DATA
    weight_column:
      default: None
    flag_column:
      default: FLAG
    cell_size:
      dtype: float
      info: 'cell size in arcseconds'
    nx:
      dtype: int
      info: 'number of pixels in x direction'
    ny:
      dtype: int
      info: 'number of pixels in y direction'
    super_resolution_factor:
      dtype: float
      default: 2.0
    field_of_view:
      dtype: float
      default: 3.0
    rmsfactor:
      dtype: float
      default: 0.65
      info: 'thresholding factor'
    robustness:
      dtype: float
      default: -0.5
      info: 'robustness factor for briggs weighting'
    nthreads_dask:
      dtype: int
      default: 4
      aliases: ['*.nthreads_dask']  # does not work. Bug in for loop?
    nvthreads:
      dtype: int
      default: 2
      aliases: ['*.nvthreads']
    nband:
      dtype: int
      default: 4
      aliases: ['*.nband']
    tol:
      dtype: float
      default: 1e-4

  steps:
    grid:
      cab: pfb_grid
      assign:
        previous_iter: =recipe.iter - 1
        model_name: '{recipe.basedir}/{recipe.obs}/data_I_{recipe.previous_iter}_model.mds'
      params:
        # cell_size: =recipe.cell_size
        # nx: =recipe.nx
        # ny: =recipe.ny
        super_resolution_factor: =recipe.super_resolution_factor
        field_of_view: =recipe.field_of_view
        robustness: =recipe.robustness
        overwrite: true
        residual: =IF(recipe.iter==0, false, true)  # Don't try to compute residual at first iteration
        l2reweight_dof: =IF(recipe.iter==0, 0, 5)  # Don't reweight at first iteration
        postfix: =recipe.iter
        nthreads_dask: =recipe.nthreads_dask
        transfer_model_from: =IF(recipe.iter==0, '', '{recipe.model_name}')
        output_filename: '{recipe.basedir}/{recipe.obs}/data'
        log_directory: '{recipe.basedir}/{recipe.obs}/logs'

    spotless:
      cab: pfb_spotless
      params:
        rmsfactor: =recipe.rmsfactor
        niter: =IF(recipe.iter==0, 30, 15)
        tol: =recipe.tol
        l1reweight_from: =IF(recipe.iter==0, 10, 5)
        pd_tol: 1e-4
        pd_report_freq: 50
        # bases: ['self','db1','db2']
        nlevels: 3
        memory_greedy: true
        postfix: =recipe.iter
        nthreads_dask: =recipe.nthreads_dask
        output_filename: '{recipe.basedir}/{recipe.obs}/data'
        log_directory: '{recipe.basedir}/{recipe.obs}/logs'

    model2comps:
      cab: pfb_model2comps
      params:
        nbasisf: 4
        overwrite: true
        postfix: =recipe.iter
        output_filename: '{recipe.basedir}/{recipe.obs}/data'
        log_directory: '{recipe.basedir}/{recipe.obs}/logs'


em_clean:
  info: Loop over em_steps

  for_loop:
    var: iter
    over: iters

  inputs:
    basedir:
      required: true
    obs:
      choices: ['F000', 'F001', 'F005', 'F01']
      required: true
    iters:
      dtype: List[int]
      default: [0,1,2,3,4,5,6,7]
      info:
        List enumerating number of EM steps to perform
    data_column:
      default: DATA
    weight_column:
      default: None
    flag_column:
      default: FLAG
    cell_size:
      dtype: float
      info: 'cell size in arcseconds'
    nx:
      dtype: int
      info: 'number of pixels in x direction'
    ny:
      dtype: int
      info: 'number of pixels in y direction'
    super_resolution_factor:
      dtype: float
      default: 2.0
    field_of_view:
      dtype: float
      default: 3.0
    sigmathreshold:
      dtype: float
      default: 2.0
      info: 'multiple of rms used to set stopping threshold'
    gamma:
      dtype: float
      default: 0.1
      info: 'Minor loop gain'
    robustness:
      dtype: float
      default: -0.5
      info: 'robustness factor for briggs weighting'
    nthreads_dask:
      dtype: int
      default: 4
      aliases: ['*.nthreads_dask']  # does not work. Bug in for loop?
    nvthreads:
      dtype: int
      default: 2
      aliases: ['*.nvthreads']
    nband:
      dtype: int
      default: 4
      aliases: ['*.nband']
    tol:
      dtype: float
      default: 1e-4

  steps:
    grid:
      cab: pfb_grid
      assign:
        previous_iter: =recipe.iter - 1
        model_name: '{recipe.basedir}/{recipe.obs}/data_I_{recipe.previous_iter}_model.mds'
      params:
        # cell_size: =recipe.cell_size
        # nx: =recipe.nx
        # ny: =recipe.ny
        super_resolution_factor: =recipe.super_resolution_factor
        field_of_view: =recipe.field_of_view
        robustness: =recipe.robustness
        overwrite: true
        residual: =IF(recipe.iter==0, false, true)  # Don't try to compute residual at first iteration
        l2reweight_dof: =IF(recipe.iter==0, 0, 5)  # Don't reweight at first iteration
        postfix: =recipe.iter
        nthreads_dask: =recipe.nthreads_dask
        transfer_model_from: =IF(recipe.iter==0, '', '{recipe.model_name}')
        output_filename: '{recipe.basedir}/{recipe.obs}/data'
        log_directory: '{recipe.basedir}/{recipe.obs}/logs'

    clean:
      cab: pfb_clean
      params:
        nmiter: =IF(recipe.iter==0, 30, 15)
        sigmathreshold: =recipe.sigmathreshold
        memory_greedy: true
        postfix: =recipe.iter
        nthreads_dask: =recipe.nthreads_dask
        output_filename: '{recipe.basedir}/{recipe.obs}/data'
        log_directory: '{recipe.basedir}/{recipe.obs}/logs'

    model2comps:
      cab: pfb_model2comps
      params:
        nbasisf: 4
        overwrite: true
        postfix: =recipe.iter
        output_filename: '{recipe.basedir}/{recipe.obs}/data'
        log_directory: '{recipe.basedir}/{recipe.obs}/logs'
