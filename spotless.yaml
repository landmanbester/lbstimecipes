_include:
  - (pfb)stimela_cabs.yaml

opts:
  log:
    dir: logs
    nest: 2

ssclean:
  name: SSCLEAN
  info: Recipe to perform single scale clean with pfb-clean

  inputs:
    ms:
      dtype: MS
      required: true
      aliases: ['*.ms']
    cpi:
      dtype: int
      default: 16
    ipi:
      dtype: int
      default: -1
    nband:
      required: True
      aliases: ['*.nband']
      info:
        Number of imaging bands
    output_filename:
      required: True
      aliases: ["*.output_filename"]
      info: Basename of ouput products
    data_column:
      dtype: str
      default: DATA
      info:
        Which column to image
    weight_column:
      dtype: str
      default: WEIGHT_SPECTRUM
    model_column:
      dtype: str
      default: MODEL_DATA
    field_of_view:
      dtype: float
      default: 2.5
      info:
        Field of view in degrees
    super_resolution_factor:
      dtype: float
      default: 2
      info:
        Will over-sample Nyquist by this factor at max frequency
    niter:
      dtype: int
      default: 10
      info:
        Number of major iterations
    gamma:
      dtype: float
      default: 1.0
      info:
        Step size
    outputs:
      dtype: str
      default: mMrRiI
      info:
        Output products. (m)odel, (r)esidual, (i)mage, (c)lean beam.
        Captitals for cubes, lower case for MFS images.
    precision:
      default: double
      aliases: ["*.precision"]
    epsilon:
      default: 1e-7
      aliases: ["*.epsilon"]
      info:
        Gridder accuracy
    wstack:
      default: true
      aliases: ["*.wstack"]
      info:
        Perform w-correction via improved w-stacking
    robustness:
      default: 0
      aliases: ["*.robustness"]
      info:
        Robustness factor for Briggs weighting. None means natural.
        A value of less than -2 implies uniform
    nthreads:
      default: 8
      aliases: ['*.nthreads']
      info:
        Total number of threads to use between all processes.
        Will use all available resources by default
    scheduler:
      default: threads
      aliases: ["*.scheduler"]
      info:
        Which dask scheduler to use.
    overwrite:
      default: false
      aliases: ["*.overwrite"]
      info:
        Allow overwriting of existing input
    rmsfactor:
      dtype: float
      default: 3.0
    positivity:
      dtype: bool
      default: true
    pd_maxit:
      dtype: int
      default: 250
    pd_tol:
      dtype: float
      default: 0.001
    pd_report_freq:
      dtype: int
      default: 50
    pd_verbose:
      dtype: int
      default: 1
    tol:
      dtype: float
      default: 0.005
    pm_maxit:
      dtype: int
      default: 250
    pm_tol:
      dtype: float
      default: 0.001



# xp = x_k - (R.H W R + I/sigma**2)^{1} nabla_x f(x)
# f(x) = x.H ( Ipsf * x - ID) + x.H I/sigma**2 x


  steps:
    init:
      cab: pfb_init
      info:
        Precompute visibilities for output products.
        In this case simply the Stokes I visibilities.
      params:
        data_column: '{recipe.data_column}'
        weight_column: '{recipe.weight_column}'
        max_field_of_view: '{recipe.field_of_view}'

    grid:
      cab: pfb_grid
      info:
        Flip visibilties into image space data products
      params:
        field_of_view: '{recipe.field_of_view}'
        super_resolution_factor: '{recipe.super_resolution_factor}'

    deconv:
      cab: pfb_spotless
      info:
        Deconvolve with spotless worker
      params:
        niter: '{recipe.niter}'
        rmsfactor: '{recipe.rmsfactor}'
        gamma: '{recipe.gamma}'
        positivity: =recipe.positivity
        pd_maxit: =recipe.pd_maxit
        pd_tol: =recipe.pd_tol
        pd_report_freq: =recipe.pd_report_freq
        pd_verbose: =recipe.pd_verbose
        tol: =recipe.tol
        pm_maxit: =recipe.pm_maxit
        pm_tol: =recipe.pm_tol

    degrid:
      cab: pfb_degrid
      info:
        Turn model image into visibilities
      params:
        model_column: "{recipe.model_column}"


