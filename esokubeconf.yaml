opts:
  backend:
    kube:
      dir: /mnt/data/pfb-test
      namespace: rarg-test-compute
      volumes:
        rarg-test-compute-efs-pvc:
          mount: /mnt/data
      context: 'lbester-rarg-test-eks-cluster'
      job_pod:
        memory:
          limit: 0
        cpu:
          request:
            0
      scheduler:
        memory:
          limit: 0
        cpu:
          request: 0
      dask_cluster:
        num_workers: 1
        worker_pod:
          memory:
            limit: 0
          cpu:
            request:
              0

      ## override user/group ID
      user:
        uid: 1000
        gid: 1000

      ## some predefined pod specs
      predefined_pod_specs:
        admin:
          nodeSelector:
            rarg/node-class: admin
        scheduler:
          nodeSelector:
            rarg/node-class: compute
            rarg/instance-type: m6i.large
            rarg/capacity-type: ON_DEMAND
        thin:
          nodeSelector:
            rarg/node-class: compute
            rarg/instance-type: c6in.2xlarge
            rarg/capacity-type: ON_DEMAND
        pudgy:
          nodeSelector:
            rarg/node-class: compute
            rarg/instance-type: c6in.8xlarge
            rarg/capacity-type: ON_DEMAND
        fat:
          nodeSelector:
            rarg/node-class: compute
            rarg/instance-type: c6in.24xlarge
            rarg/capacity-type: ON_DEMAND

      env:
        NUMBA_CACHE_DIR: /mnt/data/stimela-test
        CONFIGURATT_CACHE_DIR: /mnt/data/stimela-test

# cabs:
#   s3tolocal:
#     command: aws s3
#       inputs:

esoimage:
  steps:
    init:
      backend:
        select: singularity
        singularity:
          rebuild: true
          bind_dirs:
            /home/bester/numba_cache: rw
          env:
            NUMBA_CACHE_DIR: /home/bester/numba_cache

    grid:
      assign:
        # we need this so the workers get the right env vars
        config.opts.backend.kube.env.NUMBA_NUM_THREADS: '30'
        config.opts.backend.kube.env.NUMEXPR_NUM_THREADS: '30'
        config.opts.backend.kube.env.JAX_ENABLE_X64: 'True'
        config.opts.backend.kube.env.JAX_PLATFORMS: 'cpu'
        config.opts.backend.kube.env.LD_LIBRARY_PATH: '/usr/local/lib'
      backend:
        select: kube
        kube:
          enable: true
          job_pod:  # This is where the main application runs.
            type: pudgy
            memory:
              limit: "60Gi"
            cpu:
              request: 28  # > than half available
          dask_cluster:  # Set up the Dask cluster.
            enable: true
            num_workers: 10
            name: pfb-test-cluster
            threads_per_worker: 1
            worker_pod:
              type: pudgy
              memory:
                limit: "60Gi"
              cpu:
                request: 28
          always_pull_images: true
      params:
        fits-mfs: false
        fits-cubes: false
        nworkers: 10
        nthreads: 30


    sara:
      backend:
        select: kube
        kube:
          enable: true
          job_pod:  # This is where the main application runs.
            type: fat
            memory:
              limit: "185Gi"
            cpu:
              request: 90
          dask_cluster:  # no Dask cluster.
            enable: false
          always_pull_images: true
      params:
        fits-mfs: false
        fits-cubes: false
    # pull_model:
    #   cab: s3tolocal
    #   params:
    #     source: s3://path
    #     dest: /local/path
